!function(u){"use strict";var e=u(".cs-tab-content-wrapper"),n=loftoceanRoomiCalSyncSettings.i18nText,m={},a=864e5,v=1e3,o="YYYY-MM-DD H:mm";function h(e){return e?Base64.encode(e):""}function p(e,t,a){return void 0!==N[e]&&void 0!==N[e][t]&&N[e][t].roomID?N[e][t].roomID:a||""}function g(e,t,a,n){a?(t=n.urlBase64,void 0===N[e]?N[e]={}:n.oldURLBase64&&n.oldURLBase64!=t&&void 0!==N[e][n.oldURLBase64]&&delete N[e][n.oldURLBase64],N[e][t]=n):void 0!==N[e]&&"undefined"!=N[e][t]&&(delete N[e][t],Object.keys(N[e]).length||delete N[e])}function i(e,t){return t.diff(e)>a?n.lastSyncDatePrefix+" "+e.format(o):n.lastSyncTimePassedPrefix+" "+e.fromNow()}function l(e,t,a){e.length&&(e.data("last-sync-time",1e3*parseInt(t.unix(),10)),e.html(i(t,a)))}function d(a){var t=a.list.shift(),n=moment(),o=a.list.length;u.post(loftoceanRoomiCalSyncSettings.url,{action:loftoceanRoomiCalSyncSettings.actionSync,data:{roomID:t.room,source:t.source,time:t.time}}).always(function(){Y&&Y.length&&Y.find(".added-calendar-item[data-index="+t.itemIndex+"]").length&&l(Y.find(".added-calendar-item[data-index="+t.itemIndex+"] .added-calendar-info"),n,n),a.current++;var e=a.current===a.total?100:Math.floor(a.current/a.total*100);a.bar.css("transform","scaleX("+e/100+")"),a.counter.animate({percentage:e},{duration:700,step:function(e){e=Math.floor(e);var t=Math.max(0,a.counter.parent().width()*e/100-30);a.bar.css("transform","scaleX("+e/100+")"),a.counter.text(e+"%").css("transform","translate("+t+"px, 100%)")},complete:function(){o||(a.processingMessage.hide(),a.processedMessage.show())}}),o&&d(a)})}function c(){alert("No external Calendar found.")}var t,s,r,f,y,b,S,k,x,C,w,D,R,I,B,M,j,O,T,U,L,_,A,E,P,X,Y,N,q=e.filter("#loftocean-room-ical-sync-tab-calendars");q.length&&(z=q.find("input.button.action.doaction"),t=q.find(".loftocean-modal"),s=t.filter("#loftocean-sync-calendars"),r=s.find(".loading-bar-wrapper .load"),f=s.find(".processing"),y=s.find(".processed"),b=s.find(".loading-bar-wrapper .load-count"),S=t.filter("#loftocean-ical-import-calendar"),k=S.find(".loftocean-import-calendar-name"),x=S.find(".loftocean-import-calendar-url"),C=S.find(".loftocean-import-calendar-room-id"),w=S.find(".loftocean-import-calendar-index"),D=S.find("input.button-primary"),R=S.find(".error-message-wrapper"),I=R.find(".field-required"),B=R.find(".sync-source-existing"),M=R.find(".sync-server-error"),j=t.filter("#loftocean-ical-export-calendar"),O=j.find(".copy-link-msg"),T=wp.template("loftocean-import-calendar-item"),U=t.filter("#loftocean-delete-sync-source-item"),L=U.find(".loftocean-remove-calendar-url-base64"),_=U.find(".loftocean-remove-calendar-room-id"),A=U.find(".loftocean-remove-calendar-index"),E=U.find(".loftocean-remove-imported-booking"),Y=q.find("#the-list .column-import"),N="object"==typeof loftoceanRoomiCalSyncSettings.syncSources&&Object.keys(loftoceanRoomiCalSyncSettings.syncSources).length?loftoceanRoomiCalSyncSettings.syncSources:{},q.on("click","button.loftocean-feed-url-export",function(e){e.preventDefault(),j.find(".loftocean-room-ical-feed-url").val(loftoceanRoomiCalSyncSettings.feedBaseURL+u(this).data("room-id")),O.hide(),j.addClass("show")}).on("click",".button.action.loftocean-sync-all",function(e){e.preventDefault();var t=function(){if(Object.keys(N).length){var a={count:0,list:[]},n=Math.floor(Date.now()/1e3);return Object.keys(N).forEach(function(t){a.count+=parseInt(Object.keys(N[t]).length,10),Object.keys(N[t]).forEach(function(e){a.list.push({room:N[t][e].roomID,source:e,time:n,itemIndex:N[t][e].itemIndex})})}),a}return 0}(),e=t.count;e?(f.show(),y.hide(),r.css("transform","scaleX(0)"),b.css("transform","translate( 0px, 100%)").text("0%").prop("percentage",0),s.addClass("show"),d({bar:r,counter:b,current:0,total:e,list:t.list,processingMessage:f,processedMessage:y})):c()}),t.on("click",".modal-close",function(e){e.preventDefault(),t.removeClass("show")}).on("click",".loftocean-modal-bg-overlay",function(e){t.removeClass("show")}),U.on("click","#submit",function(e){e.preventDefault();var a=L.val(),t=_.val(),n=A.val(),o=E.is(":checked"),i="room-"+t,l=u(this),e=m[i],d=Y.filter('[data-uuid="'+e+'"]'),o={urlBase64:a,roomID:p(e,a,t),removeData:o?"on":"off"};l.attr("disabled","disabled").attr("value",l.data("update-text")),u.post(loftoceanRoomiCalSyncSettings.url,{action:loftoceanRoomiCalSyncSettings.actionRemoveSyncSource,data:o}).done(function(e,t){m[i]&&g(m[i],a,!1,{}),d.length&&d.find(".added-calendar-item[data-index="+n+"]").length&&d.find(".added-calendar-item[data-index="+n+"]").each(function(){var e=u(this);e.siblings().length||e.parent().addClass("hidden"),e.remove()}),U.removeClass("show"),E.removeAttr("checked"),L.val(""),A.val(""),_.val("")}).always(function(){l.attr("disabled",!1).attr("value",l.data("label"))})}),j.on("click",".copy-link-button .button",function(e){e.preventDefault(),j.find(".loftocean-room-ical-feed-url").focus().select(),document.execCommand("copy"),O.removeClass("hidden").show()}),S.on("click","#submit",function(e){e.preventDefault();var o=k.val(),t=x.val(),a=C.val(),i=w.val(),l=h(t),e="room-"+a,n=u(this),d=m[e],c=Y.filter('[data-uuid="'+d+'"]');if(!o||!t)return I.show(),!1;if(!i&&void 0!==N[d]&&void 0!==N[d][l])return B.show(),!1;var s=i&&c.find('.added-calendar-item[data-index="'+i+'"]').length,r=s?c.find('.added-calendar-item[data-index="'+i+'"]').data("sync-url-base64"):"",f={title:o,roomID:s?p(d,r,a):a,urlBase64:l,titleBase64:h(o),oldURLBase64:r};n.attr("disabled","disabled").attr("value",n.data("update-text")),u.post(loftoceanRoomiCalSyncSettings.url,{action:loftoceanRoomiCalSyncSettings.actionUpdateSyncSource,data:f}).done(function(e,t){var a,n=s?i:v;f.itemIndex=n,g(d,l,!0,f),c.length&&(i&&c.find('.added-calendar-item[data-index="'+i+'"]').length?((a=c.find('.added-calendar-item[data-index="'+i+'"]')).data("sync-url-base64",l).find(".edit-item").html(o),r!=l&&a.find(".added-calendar-info").data("last-sync-time","").html("")):(a=T({index:v++,list:[f]}),c.children(".added-calendars").append(a).removeClass("hidden")),S.removeClass("show"),x.val(""),k.val(""),w.val(""),C.val(""))}).error(function(){M.show()}).always(function(){n.attr("disabled",!1).attr("value",n.data("label"))})}).on("focus",'input[type="text"]',function(){R.children().hide()}),Y.on("click","button.loftocean-ical-calendar-import",function(e){e.preventDefault(),x.val(""),k.val(""),w.val(""),D.val(D.data("default-value")),C.val(u(this).parent().data("room-id")),R.children().hide(),S.addClass("show"),x.focus()}).on("click",".edit-item",function(e){e.preventDefault();var t=u(this),a=t.parent().parent();a.parent().siblings(".loftocean-ical-calendar-import").trigger("click"),x.val((e=a.data("sync-url-base64"))?Base64.decode(e):""),k.val(t.html()),w.val(a.data("index")),D.val(D.data(a.data("sync-url-base64")?"edit-value":"default-value"))}).on("click",".button.delete-button",function(e){e.preventDefault();var t=u(this),e=t.closest(".added-calendar-item");E.removeAttr("checked"),_.val(t.closest(".column-import").data("room-id")),A.val(e.data("index")),L.val(e.data("sync-url-base64")),U.addClass("show")}).on("click",".button.sync-button",function(e){e.preventDefault();var t=u(this),a=t.closest(".column-import").data("uuid"),e=t.closest(".added-calendar-item"),t=e.data("sync-url-base64");!function(e,t,a){a.trigger("change.status.loftocean",["status-syncing"]);var n=moment();u.post(loftoceanRoomiCalSyncSettings.url,{action:loftoceanRoomiCalSyncSettings.actionSync,data:{roomID:e,source:t,time:Math.floor(Date.now()/1e3)}}).done(function(e){void 0!==e&&"undefined"!=e.success?(a.trigger("change.status.loftocean",["status-synced"]),l(a.closest(".added-calendar-item").find(".added-calendar-name .added-calendar-info"),n,moment())):a.trigger("change.status.loftocean",["status-failed"])}).error(function(){a.trigger("change.status.loftocean",["status-failed"])})}(p(a,t),t,Y.filter('[data-uuid="'+a+'"]').find('.added-calendar-item[data-index="'+e.data("index")+'"] .added-calendar-sync-status'))}).on("change.status.loftocean",".added-calendar-sync-status",function(e,t){var a;void 0!==t&&((a=u(this)).removeClass("status-syncing status-synced status-failed"),"status-failed"==t?u("<div>",{class:"sync-status-text",text:n.syncFailed}).appendTo(a):a.find(".sync-status-text").remove(),t&&a.addClass(t))}),z.on("click",function(e){var t,a,n,o;return e.preventDefault(),"sync"!=u(this).siblings(".bulk-action-selector").val()||(t=q.find(".check-column input:checked")).length&&(a=[],e=0,n=Math.floor(Date.now()/1e3),o=[],t.each(function(){var e=u(this).closest("tr").find(".column-import"),t=e.data("uuid");e.find(".added-calendar-item").each(function(){var e=u(this).data("sync-url-base64");o.includes(t+e)||void 0===N[t]||void 0===N[t][e]||(o.push(t+e),a.push({room:N[t][e].roomID,source:e,time:n,itemIndex:u(this).data("index")}))})}),(e=a.length)?(f.show(),y.hide(),r.css("transform","scaleX(0)"),b.css("transform","translate( 0px, 100%)").text("0%").prop("percentage",0),s.addClass("show"),d({bar:r,counter:b,current:0,total:e,list:a,processingMessage:f,processedMessage:y})):c()),!1}),Y.length&&(Y.each(function(){var e=u(this);e.data("room-id")&&e.data("uuid")&&(m["room-"+e.data("room-id")]=e.data("uuid"))}),Object.keys(N).length&&(P=v,X=moment(),Object.keys(N).forEach(function(a){var e,t=Y.filter('[data-uuid="'+a+'"]');t.length&&Object.keys(N[a]).length&&(Object.keys(N[a]).forEach(function(e){var t;N[a][e].lastSyncTime&&((t=moment(1e3*parseInt(N[a][e].lastSyncTime,10))).isValid()?(N[a][e].lastSyncTimePassed=i(t,X),N[a][e].lastSyncTime=1e3*parseInt(N[a][e].lastSyncTime,10)):N[a][e].lastSyncTime=""),N[a][e].itemIndex=P++,N[a][e].urlBase64=e}),e=T({index:v,list:N[a]}),t.children(".added-calendars").append(e).removeClass("hidden"),v+=parseInt(Object.keys(N[a]).length,10))}))),setTimeout(function e(){var t;q.find(".added-calendar-info").length&&(t=moment(),q.find(".added-calendar-info").each(function(){var e=u(this);e.data("last-sync-time")&&e.html(i(moment(parseInt(e.data("last-sync-time"),10)),t))}),setTimeout(function(){e()},3e5))},3e5));var F,G,H,Q,V,W,z=e.filter("#loftocean-room-ical-sync-tab-imported-bookings");z.length&&(F=z.find(".loftocean-modal.imported-order"),G=F.find(".cs-order-preview"),H=F.find(".booking-title .order-number"),Q=wp.template("loftocean-room-order-details"),z.on("click","#the-list .order-view",function(e){e.preventDefault();e=u(this).data("order-id");G.html("").addClass("loading"),H.text(e),F.addClass("show"),u.post(loftoceanRoomiCalSyncSettings.url,{action:loftoceanRoomiCalSyncSettings.actionGetImportedBookingDetail,data:{order_id:e}}).done(function(e,t){e=Q(e.data.detail);G.removeClass("loading").append(e)}).error(function(){var e=Q({});G.removeClass("loading").append(e)})}).on("click",".button.loftocean-delete-all-bookings",function(e){e.preventDefault();var t=u(this);t.attr("disabled","disabled").addClass("loading"),u.post(loftoceanRoomiCalSyncSettings.url,{action:loftoceanRoomiCalSyncSettings.actionRemoveAllBookings}).always(function(){t.removeAttr("disabled").removeClass("loading"),window.location.reload()})}),F.on("click",".modal-close",function(e){e.preventDefault(),F.removeClass("show")}).on("click",".loftocean-modal-bg-overlay",function(e){e.preventDefault(),F.removeClass("show")})),(e=e.filter("#loftocean-room-ical-sync-tab-settings")).length&&(V=e.find(".loftocean-auto-sync-interval-wrapper"),W=e.find(".auto-sync-interval-option-wrapper"),e.on("change","input[name=enable_auto_sync]",function(e){u(this).is(":checked")?V.show():V.hide()}).on("change","select[name=auto_sync_interval]",function(e){"loftocean_24hours"==u(this).val()?W.show():W.hide()}).on("click",".loftocean-clear-booking-records",function(e){e.preventDefault();var t=u(this);t.attr("disabled","disabled").addClass("loading"),u.post(loftoceanRoomiCalSyncSettings.url,{action:loftoceanRoomiCalSyncSettings.actionRemoveBookingsWithoutExistingSource}).always(function(){t.removeAttr("disabled").removeClass("loading")})})),u("body").on("keypress",".current-page-selector",function(e){var t=u(this);t.data("url-base")&&t.val()&&"13"==(e.keyCode||e.which)&&(window.location.href=t.data("url-base")+t.val())})}(jQuery);